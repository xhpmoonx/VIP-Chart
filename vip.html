<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
            <title>Curriculum Graph - VIP Course</title>
                <style>
                  
                    body {
                    font-family: system-ui, sans-serif;
                    background: #f8fafc;
                    padding: 40px;
                    }

                    .grid {
                    display: grid;
                    grid-template-columns: repeat(8, 200px);
                    grid-template-rows: repeat(7, 100px) auto;
                    gap: 20px;
                    position: relative;
                    width: max-content;
                    }

                    .term-header {
                    text-align: center;
                    font-weight: bold;
                    color: #0f172a;
                    font-size: 1.2em;
                    grid-row: 1;
                    }

                    .term-footer {
                    font-size: 0.9em;
                    color: #475569;
                    text-align: center;
                    grid-row: 6;
                    }

                    .course {
                    background: transparent;
                    box-shadow: none;
                    border-radius: 0;
                    padding: 0;
                    z-index: 2;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    }

                    /* Base Circle Style */
                    .circle {
                      width: 30px;
                      height: 30px;
                      font-weight: bold;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-bottom: 6px;
                      background: yellow;
                      border: 3px solid #ef4444;
                    }

                    /* Core: Default Circle */
                    .course[data-type="core"] .circle {
                      border-radius: 50%;
                    }

                    /* GE: Square */
                    .course[data-type="ge"] .circle {
                      border-radius: 8px;
                    }

                    /* Elective: Pill shape */
                    .course[data-type="elective"] .circle {
                      border-radius: 999px;
                      width: 60px;
                      height: 28px;
                    }
                    
                    .course[data-type="capstone"] .triangle {
                    position: relative;
                    width: 0;
                    height: 0;
                    border-left: 24px solid transparent;
                    border-right: 24px solid transparent;
                    border-bottom: 42px solid #ef4444; /* default red outer */
                    margin-bottom: 6px;
                  }


                                      .course[data-type="capstone"] .triangle::after {
                    content: attr(data-units);
                    position: absolute;
                    top: 10px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-weight: bold;
                    font-size: 0.9em;
                    color: black;
                    z-index: 2;
                    pointer-events: none;
                  }
                  .course[data-type="capstone"] .triangle::before {
                    content: "";
                    position: absolute;
                    top: 4px;
                    left: -20px;
                    border-left: 20px solid transparent;
                    border-right: 20px solid transparent;
                    border-bottom: 34px solid yellow;
                    z-index: 1;
                  }   
                  /* Unmet Prereqs â€“ triangle orange */
                  .course.unmet[data-type="capstone"] .triangle {
                    border-bottom-color: rgb(51, 139, 216);
                  }

                  .course.unmet[data-type="capstone"] .triangle::before {
                    border-bottom-color: #b6f895; /* pale yellow fill */
                  }

                  /* Optional: for other shapes too */
                  .course.unmet .circle {
                    border-color: orange;
                  }
             
                    .label {
                    font-size: 0.85em;
                    color: #0f172a;
                    text-align: center;
                    }

                    svg {
                    position: absolute;
                    top: 0;
                    left: 0;
                    z-index: 10;
                    pointer-events: none; /*auto*/
                    }

                    .arrow {
                    stroke: #ef4444;
                    stroke-width: 2.5;
                    fill: none;
                    /*marker-end: url(#arrow);*/
                    }
                    .course:hover .circle {
                        border-color: #3b82f6;
                        box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
                    }
                    .course:hover[data-type="capstone"] .triangle {
                        border-bottom-color: #3b82f6; /* blue outer */
                        filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.5));
                      }

                    .arrow {
                        transition: stroke 0.2s ease, opacity 0.2s ease;
                        opacity: 0.3;
                    }

                    .arrow.highlighted {
                        stroke: #3b82f6;
                        opacity: 1;
                    }
                    /* dim all arrows/courses when a focus is active */
                    .grid.dimmed .course:not(.active) .circle {
                    border-color: #94a3b8;
                    background: #f1f5f9;
                    color: #94a3b8;
                    opacity: 0.3;
                    box-shadow: none;
                    }

                    .grid.dimmed .arrow:not(.highlighted) {
                    opacity: 0.1;
                    }

                    .course.active .circle {
                    border-color: #3b82f6;
                    background: yellow;
                    box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
                    }
                    .popup {
                    position: absolute;
                    background: white;
                    border: 1px solid #cbd5e1;
                    border-radius: 8px;
                    padding: 10px 14px;
                    font-size: 0.85em;
                    color: #0f172a;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    pointer-events: none;
                    z-index: 20;
                    display: none;
                    white-space: nowrap;
                    }

                    .layout {
                      display: grid;
                      grid-template-columns: 1fr 200px;
                      height: 100vh;
                      overflow: hidden;
                    }

                    .main-content {
                      overflow: auto;
                      padding: 40px;
                      position: relative;
                    }

                    .key {
                      background: white;
                      border-left: 1px solid #e2e8f0;
                      padding: 20px;
                      font-size: 0.9em;
                      color: #0f172a;
                      box-shadow: -2px 0 8px rgba(0,0,0,0.04);
                      height: 100%;
                      position: relative;
                      z-index: 10;
                    }


                  .key h3 {
                    margin-top: 0;
                    font-size: 1em;
                    margin-bottom: 8px;
                  }

                  .key ul {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                  }

                  .key li {
                    display: flex;
                    align-items: center;
                    margin-bottom: 6px;
                  }

                  .key .circle.example {
                    width: 22px;
                    height: 22px;
                    font-size: 0.8em;
                    margin-right: 10px;
                    background: yellow;
                    border: 2px solid #ef4444;
                  }

                  .key-line {
                    display: inline-block;
                    width: 30px;
                    height: 3px;
                    margin-right: 10px;
                    background: #ef4444;
                  }

                  .key-line.prereq {
                    opacity: 0.3;
                  }

                  .key-line.blocked {
                    background: #3b82f6;
                  }

                  .key-line.all {
                    background: #475569;
                  }

                </style>
    </head>
<body>

  <div class="layout">
    <div class="main-content">
      <div id="popup" class="popup"></div>
  
      <div class="grid" id="curriculum">
        <svg id="svg" width="1000" height="800">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5"
              markerWidth="4" markerHeight="4" orient="auto">
            </marker>
          </defs>
        </svg>
      </div>
    </div>
  
    <div class="key">
      <h3>Key</h3>
      <ul>
        <li><span class="circle example">4</span> = Course Units</li>
        <li><span class="key-line prereq"></span> Prerequisite</li>
        <li><span class="key-line blocked"></span> Directly Blocked</li>
        <li><span class="key-line all"></span> All Dependencies</li>
      </ul>
    </div>
  </div>

  <script>
    let curriculum = [];
    let arrows = [];

    fetch('curriculum.json')
    .then(res => res.json())
    .then(data => {
      curriculum = data;
      arrows = curriculum.flatMap(course =>
        course.prereqs.map(pr => ({ from: pr, to: course.id }))
      );
      renderCourses();
      markUnmetPrereqs();
      requestAnimationFrame(() => {
        renderArrows();
      });
    })
    .catch(err => console.error("Failed to load curriculum.json:", err));

    function markUnmetPrereqs() {
      curriculum.forEach(course => {
        const courseTerm = course.term;
        const unmet = course.prereqs.filter(prereqId => {
          const prereq = curriculum.find(c => c.id === prereqId);
          return prereq && prereq.term >= courseTerm;
        });

        if (unmet.length) {
          const el = document.getElementById(course.id);
          el.classList.add('unmet');
        }
      });
    }


    function createCourse(course) {
      const div = document.createElement("div");
      div.className = "course";
      div.id = course.id;
      div.dataset.type = course.type;
      div.style.gridColumn = course.term;
      div.style.gridRow = course.row;

      const shapeType = course.type === "capstone" ? "triangle" : "circle";
      const shapeEl = document.createElement("div");
      shapeEl.className = shapeType;

      if (course.type === "capstone") {
        shapeEl.dataset.units = course.units;
      } else {
        shapeEl.textContent = course.units;
      }

      const label = document.createElement("div");
      label.className = "label";
      label.innerHTML = course.label;

      div.appendChild(shapeEl);
      div.appendChild(label);
      return div;
    }

    function renderCourses() {
      const grid = document.getElementById("curriculum");
      curriculum.forEach(course => {
        const el = createCourse(course);
        grid.appendChild(el);
      });
    }
    //Draws one curved SVG arrow between two course circles
    function drawArrow(fromId, toId) {
        const svg = document.getElementById('svg');
        const fromShape = document.querySelector(`#${fromId} .circle, #${fromId} .triangle`);
        const toShape = document.querySelector(`#${toId} .circle, #${toId} .triangle`);
        if (!fromShape || !toShape) return;

        const svgRect = svg.getBoundingClientRect();
        const from = fromShape.getBoundingClientRect();
        const to = toShape.getBoundingClientRect();

        const startX = from.right - svgRect.left;
        const startY = from.top + from.height / 2 - svgRect.top;

        const endX = to.left - svgRect.left;
        const endY = to.top + to.height / 2 - svgRect.top;

        const curveY = 30; //makes it subtler or more pronounced
        const dx = endX - startX;
        const curveX = Math.max(40, Math.min(dx / 2, 80)); // horizontal curve

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("class", "arrow");
        path.setAttribute("d",`M ${startX} ${startY} C ${startX + curveX} ${startY - curveY}, ${endX - curveX} ${endY - curveY}, ${endX} ${endY}`);        
        // Store the source course ID so we can highlight it later
        path.dataset.from = fromId;
        path.dataset.to = toId;

        svg.appendChild(path);
        }
    //Clears and redraws all arrows, and adds hover listeners
    function renderArrows() {
        const svg = document.getElementById('svg');
        const grid = document.getElementById('curriculum');
        const gridRect = grid.getBoundingClientRect();

        svg.setAttribute('width', grid.scrollWidth);
        svg.setAttribute('height', grid.scrollHeight);
        //Remove all existing arrows from the SVG
        svg.querySelectorAll('.arrow').forEach(e => e.remove()); 
        //Loop through arrow list and draw each one
        arrows.forEach(({ from, to }) => {drawArrow(from, to);});
        //Add hover event listeners for interactivity
        document.querySelectorAll('.course').forEach(el => {
                el.addEventListener('mouseenter', () => highlightArrows(el.id));
                el.addEventListener('mouseleave', clearHighlights);
            });
        //Add click listeners to all courses to show popup info
            document.querySelectorAll('.course').forEach(course => {
                course.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCourseInfo(course);
                });
                });
        //Hide popup if you click anywhere else on the page
            document.addEventListener('click', () => {
            document.getElementById('popup').style.display = 'none';
            });
    }
    //Highlights all arrows that start from a given course
    function highlightArrows(courseId) {
        const grid = document.getElementById('curriculum');
        grid.classList.add('dimmed');

        document.querySelectorAll('.arrow').forEach(path => {
            path.classList.remove('highlighted');
            if (path.dataset.from === courseId || path.dataset.to === courseId) {
            path.classList.add('highlighted');
            }
        });

        document.querySelectorAll('.course').forEach(el => {
            el.classList.remove('active');
            if (el.id === courseId) {
            el.classList.add('active');
            }
        });
    }
    //Removes all arrow highlights (when hover ends)
    function clearHighlights() {
        const grid = document.getElementById('curriculum');
        grid.classList.remove('dimmed');

        document.querySelectorAll('.arrow').forEach(path => {
            path.classList.remove('highlighted');
        });

        document.querySelectorAll('.course').forEach(el => {
            el.classList.remove('active');
        });
    }
    //Show popup box with course info (prereqs and dependencies)
    function showCourseInfo(courseEl) {
  const id = courseEl.id;
  const course = curriculum.find(c => c.id === id);
  if (!course) return;

  const prereqFor = arrows.filter(a => a.from === id).map(a => a.to);
  const dependsOn = arrows.filter(a => a.to === id).map(a => a.from);

  const lines = [];
  lines.push(`<strong>${course.label.replace('\n', ' ')}</strong>`);
  lines.push(`Units: ${course.units}`);

  if (dependsOn.length) {
    const labels = dependsOn.map(depId =>
      curriculum.find(c => c.id === depId)?.label?.split('\n')[0] || depId
    );
    lines.push("Depends on: " + labels.join(", "));
  }

  if (prereqFor.length) {
    const labels = prereqFor.map(prId =>
      curriculum.find(c => c.id === prId)?.label?.split('\n')[0] || prId
    );
    lines.push("Prerequisite for: " + labels.join(", "));
  }

  if (!dependsOn.length && !prereqFor.length) {
    lines.push("No direct connections");
  }

  const popup = document.getElementById('popup');
  popup.innerHTML = lines.join("<br>");
  popup.style.display = 'block';

  // ðŸ§  Get the actual screen position of the course element
  const rect = courseEl.getBoundingClientRect();

  // âœ… Position the popup relative to the screen (fixed)
  popup.style.position = 'fixed';
  popup.style.left = `${rect.left}px`;
  popup.style.top = `${rect.bottom + 6}px`; // 6px below the course
}

    window.addEventListener('load', renderArrows);
    window.addEventListener('resize', renderArrows);
  </script>
</body>
</html>
